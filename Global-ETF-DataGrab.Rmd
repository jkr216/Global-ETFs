---
title: "R Notebook ETF"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(readxl)
library(lubridate)
library(dplyr)
Global_ETF_symbols <- read_excel("~/Global-ETFs/Global-ETF-symbols.xlsx")
Global_ETF_symbols$Inception <- ymd(Global_ETF_symbols$Inception)
Global_ETF_symbols$Country <- gsub("iShares|MSCI|ETF|capped|currency|hedged|large-cap|all|min|vol|small-cap|adaptive|edge|\\b\\w{1,2}\\s", "", Global_ETF_symbols$Country, ignore.case = TRUE)
Global_ETF_symbols$Country <- gsub("^\\s+|\\s+$", "", Global_ETF_symbols$Country)
Global_ETF_symbols$Country[47]<-"United Arab Emirates"
Global_ETF_symbols<-Global_ETF_symbols[-65, ]
```

```{r, warning = FALSE}
library(quantmod)
library(PerformanceAnalytics)

getSymbols(Global_ETF_symbols$Symbol, auto.assign = TRUE, warnings = FALSE)

#Loop through symbols, fetch prices, and store in myList
##lapply(Global_ETF_symbols$Symbol, function(x) {(getSymbols(x, auto.assign = FALSE))})
##names(myList) <- Global_ETF_symbols$Country

##think about the different start dates, or just live with the 2007 and map it
testList <- do.call(merge, lapply(Global_ETF_symbols$Symbol, function(x) Cl(get(x))))
colnames(testList) <- Global_ETF_symbols$Country
duplicated(colnames(testList))
names_unique <- testList[, !duplicated(colnames(testList))]
colnames(names_unique)[7] <- "Korea"
dygraph(names_unique[,"India"])
```


```{r, warning = FALSE}
##the packages we need to grab the map data
library(rgdal)
library(sp)
library(leaflet)

##where to find the world map
## "http://www.naturalearthdata.com/http//www.naturalearthdata.com/download/50m/cultural/ne_50m_admin_0_countries.zip"

## Create spatial data frame
## Have a look at this in the global environment after it is loaded
## it contains the shape file, and population and gdp data, amongst other things
world <-readOGR(".", "CopyOfne_50m_admin_0_countries", verbose = FALSE)
##create shading by GDP
qpal <- colorQuantile("Blues", world$gdp_md_est, n = 20)

##create popup country name and economic stage
popup <- paste0("<strong>Country: </strong>", 
                world$name, 
                "<br><strong>Market Stage: </strong>", 
                world$economy)

leaf_world <- leaflet(world) %>%
  addProviderTiles("CartoDB.Positron") %>% 
  setView(lng =  20, lat =  15, zoom = 2) %>%
      addPolygons(stroke = FALSE, smoothFactor = 0.2, fillOpacity = .7, color =
      ~qpal(gdp_md_est), layerId = ~name, popup = popup)

leaf_world
```

```{r}
### Save
save(leaf_world, names_unique, file = 'sourceData.RDat')
```





